<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸å‹•ç”¢è³‡æ–™ CSV ä¸Šå‚³å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.38.0/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #5a6fd8;
        }

        .upload-area.dragover {
            background: #f0f4ff;
            border-color: #4c63d2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #666;
            font-size: 0.9em;
        }

        .file-list {
            margin-bottom: 30px;
        }

        .file-item {
            background: #f1f3f4;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            display: flex;
            align-items: center;
        }

        .file-icon {
            margin-right: 15px;
            font-size: 1.5em;
            color: #667eea;
        }

        .file-details h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .file-details p {
            color: #666;
            font-size: 0.9em;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .remove-btn:hover {
            background: #ff3742;
        }

        .upload-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
            margin-bottom: 20px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            color: #333;
            font-weight: bold;
        }

        .log-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .log-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-success { color: #27ae60; }
        .log-error { color: #e74c3c; }
        .log-info { color: #3498db; }
        .log-warning { color: #f39c12; }

        .hidden {
            display: none;
        }

        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  ä¸å‹•ç”¢è³‡æ–™ä¸Šå‚³å·¥å…·</h1>
            <p>è¼•é¬†ä¸Šå‚³æ‚¨çš„ CSV æª”æ¡ˆåˆ° Supabase è³‡æ–™åº«</p>
        </div>

        <div class="config-section">
            <h3>ğŸ“‹ Supabase è¨­å®š</h3>
            <div class="input-group">
                <label for="supabaseUrl">Supabase URL</label>
                <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" />
            </div>
            <div class="input-group">
                <label for="supabaseKey">Supabase API Key</label>
                <input type="password" id="supabaseKey" placeholder="your-anon-key" />
            </div>
        </div>

        <div class="config-section">
            <h3>ğŸ¯ æ¬„ä½ç¯©é¸è¨­å®š</h3>
            <div class="input-group">
                <label>
                    <input type="radio" name="fieldMode" value="all" checked /> 
                    ä¸Šå‚³æ‰€æœ‰æ¬„ä½
                </label>
            </div>
            <div class="input-group">
                <label>
                    <input type="radio" name="fieldMode" value="selected" /> 
                    åªä¸Šå‚³é¸å®šæ¬„ä½
                </label>
            </div>
            <div id="fieldSelection" style="display: none; margin-top: 20px;">
                <p style="color: #666; margin-bottom: 15px;">è«‹é¸æ“‡è¦ä¸Šå‚³çš„æ¬„ä½ï¼ˆå…ˆé¸æ“‡æª”æ¡ˆå¾Œæœƒé¡¯ç¤ºå¯é¸æ¬„ä½ï¼‰</p>
                <div id="fieldCheckboxes"></div>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">æ‹–æ‹‰ CSV æª”æ¡ˆåˆ°é€™è£¡</div>
            <div class="upload-hint">æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ (æ”¯æ´å¤šæª”æ¡ˆé¸æ“‡)</div>
            <input type="file" id="fileInput" multiple accept=".csv" />
        </div>

        <div class="file-list" id="fileList"></div>

        <button class="upload-btn" id="uploadBtn" disabled>é–‹å§‹ä¸Šå‚³è³‡æ–™ ğŸš€</button>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">æº–å‚™ä¸Šå‚³...</div>
        </div>

        <div class="log-container" id="logContainer">
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let supabase = null;

        // æ ¹æ“šæ–‡ä»¶çš„æ¬„ä½å°æ‡‰è¡¨
        const fieldMappings = {
            // ä¸­å¤äº¤æ˜“ä¸»è¡¨ (a_lvr_land_a.csv)
            'a_lvr_land_a.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'é„‰é®å¸‚å€': 'è¡Œæ”¿å€', 
                'äº¤æ˜“æ¨™çš„': 'äº¤æ˜“æ¨™çš„',
                'åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ': 'åœ°å€',
                'äº¤æ˜“å¹´æœˆæ—¥': 'äº¤æ˜“æ—¥',
                'äº¤æ˜“ç­†æ£Ÿæ•¸': 'äº¤æ˜“ç­†æ£Ÿæ•¸',
                'ç§»è½‰å±¤æ¬¡': 'æ¨“å±¤',
                'å»ºç‰©å‹æ…‹': 'å»ºç‰©å‹æ…‹',
                'ä¸»è¦ç”¨é€”': 'ä¸»è¦ç”¨é€”',
                'å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º': 'ç”¢æ¬Šé¢ç©(æˆ¿è»Š)',
                'å»ºç‰©ç¾æ³æ ¼å±€-æˆ¿': 'æˆ¿æ•¸',
                'å»ºç‰©ç¾æ³æ ¼å±€-å»³': 'å»³æ•¸',
                'å»ºç‰©ç¾æ³æ ¼å±€-è¡›': 'è¡›æµ´æ•¸',
                'ç¸½åƒ¹å…ƒ': 'äº¤æ˜“ç¸½åƒ¹',
                'è»Šä½é¡åˆ¥': 'è»Šä½é¡åˆ¥',
                'è»Šä½ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º': 'è»Šä½ç¸½é¢ç©',
                'è»Šä½ç¸½åƒ¹å…ƒ': 'è»Šä½ç¸½åƒ¹',
                'å‚™è¨»': 'å‚™è¨»',
                'ä¸»å»ºç‰©é¢ç©': 'ä¸»å»ºç‰©é¢ç©',
                'é™„å±¬å»ºç‰©é¢ç©': 'é™„å±¬å»ºç‰©é¢ç©',
                'é™½å°é¢ç©': 'é™½å°é¢ç©'
            },
            // é å”®äº¤æ˜“ä¸»è¡¨ (a_lvr_land_b.csv)
            'a_lvr_land_b.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'é„‰é®å¸‚å€': 'è¡Œæ”¿å€',
                'äº¤æ˜“æ¨™çš„': 'äº¤æ˜“æ¨™çš„', 
                'åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ': 'åœ°å€',
                'äº¤æ˜“å¹´æœˆæ—¥': 'äº¤æ˜“æ—¥',
                'äº¤æ˜“ç­†æ£Ÿæ•¸': 'äº¤æ˜“ç­†æ£Ÿæ•¸',
                'ç§»è½‰å±¤æ¬¡': 'æ¨“å±¤',
                'å»ºç‰©å‹æ…‹': 'å»ºç‰©å‹æ…‹',
                'ä¸»è¦ç”¨é€”': 'ä¸»è¦ç”¨é€”',
                'å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º': 'ç”¢æ¬Šé¢ç©(æˆ¿è»Š)',
                'å»ºç‰©ç¾æ³æ ¼å±€-æˆ¿': 'æˆ¿æ•¸',
                'å»ºç‰©ç¾æ³æ ¼å±€-å»³': 'å»³æ•¸',
                'å»ºç‰©ç¾æ³æ ¼å±€-è¡›': 'è¡›æµ´æ•¸',
                'ç¸½åƒ¹å…ƒ': 'äº¤æ˜“ç¸½åƒ¹',
                'è»Šä½é¡åˆ¥': 'è»Šä½é¡åˆ¥',
                'è»Šä½ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º': 'è»Šä½ç¸½é¢ç©',
                'è»Šä½ç¸½åƒ¹å…ƒ': 'è»Šä½ç¸½åƒ¹',
                'å‚™è¨»': 'å‚™è¨»',
                'å»ºæ¡ˆåç¨±': 'å»ºæ¡ˆåç¨±',
                'æ£ŸåŠè™Ÿ': 'æˆ¶åˆ¥',
                'è§£ç´„æƒ…å½¢': 'è§£ç´„æƒ…å½¢'
            },
            // ç§Ÿè³ƒäº¤æ˜“ä¸»è¡¨ (a_lvr_land_c.csv)
            'a_lvr_land_c.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'é„‰é®å¸‚å€': 'è¡Œæ”¿å€',
                'äº¤æ˜“æ¨™çš„': 'äº¤æ˜“æ¨™çš„',
                'åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ': 'åœ°å€',
                'ç§Ÿè³ƒå¹´æœˆæ—¥': 'äº¤æ˜“æ—¥',
                'ç§Ÿè³ƒç­†æ£Ÿæ•¸': 'äº¤æ˜“ç­†æ£Ÿæ•¸',
                'ç§Ÿè³ƒå±¤æ¬¡': 'æ¨“å±¤',
                'å»ºç‰©å‹æ…‹': 'å»ºç‰©å‹æ…‹',
                'ä¸»è¦ç”¨é€”': 'ä¸»è¦ç”¨é€”',
                'å»ºç‰©ç¸½é¢ç©å¹³æ–¹å…¬å°º': 'ç§Ÿè³ƒé¢ç©',
                'å»ºç‰©ç¾æ³æ ¼å±€-æˆ¿': 'æˆ¿æ•¸',
                'å»ºç‰©ç¾æ³æ ¼å±€-å»³': 'å»³æ•¸',
                'å»ºç‰©ç¾æ³æ ¼å±€-è¡›': 'è¡›æµ´æ•¸',
                'ç¸½é¡å…ƒ': 'äº¤æ˜“ç¸½åƒ¹',
                'è»Šä½é¡åˆ¥': 'è»Šä½é¡åˆ¥',
                'è»Šä½é¢ç©å¹³æ–¹å…¬å°º': 'è»Šä½ç¸½é¢ç©',
                'è»Šä½ç¸½é¡å…ƒ': 'è»Šä½ç¸½åƒ¹',
                'å‚™è¨»': 'å‚™è¨»',
                'å‡ºç§Ÿå‹æ…‹': 'å‡ºç§Ÿå‹æ…‹',
                'ç§Ÿè³ƒæœŸé–“': 'ç§Ÿè³ƒæœŸé–“',
                'é™„å±¬è¨­å‚™': 'é™„å±¬è¨­å‚™',
                'ç§Ÿè³ƒä½å®…æœå‹™': 'ç§Ÿè³ƒä½å®…æœå‹™'
            },
            // å»ºç‰©äº¤æ˜“é™„è¡¨
            'a_lvr_land_a_build.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'å±‹é½¡': 'äº¤æ˜“å±‹é½¡',
                'ä¸»è¦å»ºæ': 'çµæ§‹',
                'å»ºç¯‰å®Œæˆæ—¥æœŸ': 'å®Œå·¥æ—¥',
                'ç¸½å±¤æ•¸': 'ç¸½æ¨“å±¤',
                'ç§»è½‰æƒ…å½¢': 'ç§»è½‰æƒ…å½¢'
            },
            'a_lvr_land_c_build.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'å±‹é½¡': 'äº¤æ˜“å±‹é½¡',
                'ä¸»è¦å»ºæ': 'çµæ§‹',
                'å»ºç¯‰å®Œæˆæ—¥æœŸ': 'å®Œå·¥æ—¥',
                'ç¸½å±¤æ•¸': 'ç¸½æ¨“å±¤',
                'ç§»è½‰æƒ…å½¢': 'ç§»è½‰æƒ…å½¢'
            },
            // åœŸåœ°äº¤æ˜“é™„è¡¨
            'a_lvr_land_a_land.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'åœŸåœ°ä½ç½®': 'åœ°è™Ÿ(æ®µ)',
                'åœ°è™Ÿ': 'åœ°è™Ÿ',
                'åœŸåœ°ç§»è½‰é¢ç©å¹³æ–¹å…¬å°º': 'åœŸåœ°æŒåˆ†é¢ç©',
                'æ¬Šåˆ©äººæŒåˆ†åˆ†æ¯': 'æŒåˆ†åˆ†æ¯',
                'æ¬Šåˆ©äººæŒåˆ†åˆ†å­': 'æŒåˆ†åˆ†å­',
                'ä½¿ç”¨åˆ†å€æˆ–ç·¨å®š': 'ä½¿ç”¨åˆ†å€'
            },
            'a_lvr_land_b_land.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'åœŸåœ°ä½ç½®': 'åœ°è™Ÿ(æ®µ)',
                'åœ°è™Ÿ': 'åœ°è™Ÿ',
                'åœŸåœ°ç§»è½‰é¢ç©å¹³æ–¹å…¬å°º': 'åœŸåœ°æŒåˆ†é¢ç©',
                'æ¬Šåˆ©äººæŒåˆ†åˆ†æ¯': 'æŒåˆ†åˆ†æ¯',
                'æ¬Šåˆ©äººæŒåˆ†åˆ†å­': 'æŒåˆ†åˆ†å­',
                'ä½¿ç”¨åˆ†å€æˆ–ç·¨å®š': 'ä½¿ç”¨åˆ†å€'
            },
            'a_lvr_land_c_land.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'åœŸåœ°ä½ç½®': 'åœ°è™Ÿ(æ®µ)',
                'åœ°è™Ÿ': 'åœ°è™Ÿ',
                'åœŸåœ°ç§»è½‰é¢ç©å¹³æ–¹å…¬å°º': 'åœŸåœ°ç§Ÿè³ƒé¢ç©',
                'ä½¿ç”¨åˆ†å€æˆ–ç·¨å®š': 'ä½¿ç”¨åˆ†å€'
            },
            // è»Šä½äº¤æ˜“é™„è¡¨
            'a_lvr_land_a_park.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'è»Šä½é¡åˆ¥': 'è»Šä½é¡åˆ¥',
                'è»Šä½åƒ¹æ ¼': 'è»Šä½åƒ¹æ ¼',
                'è»Šä½é¢ç©å¹³æ–¹å…¬å°º': 'è»Šä½é¢ç©',
                'è»Šä½æ‰€åœ¨æ¨“å±¤': 'è»Šä½æ¨“å±¤'
            },
            'a_lvr_land_b_park.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'è»Šä½é¡åˆ¥': 'è»Šä½é¡åˆ¥',
                'è»Šä½åƒ¹æ ¼': 'è»Šä½åƒ¹æ ¼',
                'è»Šä½é¢ç©å¹³æ–¹å…¬å°º': 'è»Šä½é¢ç©',
                'è»Šä½æ‰€åœ¨æ¨“å±¤': 'è»Šä½æ¨“å±¤'
            },
            'a_lvr_land_c_park.csv': {
                'ç·¨è™Ÿ': 'ç·¨è™Ÿ',
                'è»Šä½é¡åˆ¥': 'è»Šä½é¡åˆ¥',
                'è»Šä½åƒ¹æ ¼': 'è»Šä½åƒ¹æ ¼',
                'è»Šä½é¢ç©å¹³æ–¹å…¬å°º': 'è»Šä½é¢ç©',
                'è»Šä½æ‰€åœ¨æ¨“å±¤': 'è»Šä½æ¨“å±¤'
            }
        };

        // æ ¹æ“šæª”æ¡ˆåç¨±æ±ºå®šä½¿ç”¨å“ªå€‹æ¬„ä½å°æ‡‰
        function getFieldMapping(fileName) {
            return fieldMappings[fileName] || {};
        }

        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const logContainer = document.getElementById('logContainer');
        const logContent = document.getElementById('logContent');
        const supabaseUrl = document.getElementById('supabaseUrl');
        const supabaseKey = document.getElementById('supabaseKey');

        // äº‹ä»¶ç›£è½å™¨
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);
        uploadBtn.addEventListener('click', startUpload);
        supabaseUrl.addEventListener('input', checkConfig);
        supabaseKey.addEventListener('input', checkConfig);
        
        // æ¬„ä½é¸æ“‡æ¨¡å¼åˆ‡æ›
        document.querySelectorAll('input[name="fieldMode"]').forEach(radio => {
            radio.addEventListener('change', showFieldSelection);
        });

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.name.endsWith('.csv'));
            addFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            files.forEach(file => {
                if (!selectedFiles.find(f => f.name === file.name)) {
                    selectedFiles.push(file);
                }
            });
            renderFileList();
            checkConfig();
        }

        function removeFile(fileName) {
            selectedFiles = selectedFiles.filter(f => f.name !== fileName);
            renderFileList();
            checkConfig();
        }

        function renderFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';
                
                const fileIcon = document.createElement('div');
                fileIcon.className = 'file-icon';
                fileIcon.textContent = 'ğŸ“„';
                
                const fileDetails = document.createElement('div');
                fileDetails.className = 'file-details';
                fileDetails.innerHTML = `
                    <h4>${file.name}</h4>
                    <p>${(file.size / 1024).toFixed(1)} KB</p>
                `;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'ç§»é™¤';
                removeBtn.onclick = () => removeFile(file.name);
                
                fileInfo.appendChild(fileIcon);
                fileInfo.appendChild(fileDetails);
                fileItem.appendChild(fileInfo);
                fileItem.appendChild(removeBtn);
                fileList.appendChild(fileItem);
            });
            
            // æ›´æ–°æ¬„ä½é¸æ“‡æ¡†
            updateFieldCheckboxes();
        }

        function checkConfig() {
            const hasUrl = supabaseUrl.value.trim();
            const hasKey = supabaseKey.value.trim();
            const hasFiles = selectedFiles.length > 0;
            
            uploadBtn.disabled = !(hasUrl && hasKey && hasFiles);
            
            if (hasUrl && hasKey) {
                try {
                    supabase = window.supabase.createClient(supabaseUrl.value.trim(), supabaseKey.value.trim());
                } catch (error) {
                    log('è¨­å®šéŒ¯èª¤: ' + error.message, 'error');
                }
            }
        }

        function log(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logContent.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            if (logContainer.style.display === 'none') {
                logContainer.style.display = 'block';
            }
        }

        function updateProgress(current, total, message) {
            const percentage = (current / total) * 100;
            progressFill.style.width = percentage + '%';
            progressText.textContent = message;
        }

        async function startUpload() {
            if (!supabase) {
                log('è«‹å…ˆè¨­å®š Supabase é€£ç·šè³‡è¨Š', 'error');
                return;
            }

            uploadBtn.disabled = true;
            progressContainer.style.display = 'block';
            logContent.innerHTML = '';
            
            let totalFiles = selectedFiles.length;
            let processedFiles = 0;

            log('é–‹å§‹ä¸Šå‚³ç¨‹åº...', 'info');

            for (const file of selectedFiles) {
                try {
                    updateProgress(processedFiles, totalFiles, `è™•ç†æª”æ¡ˆ: ${file.name}`);
                    log(`è™•ç†æª”æ¡ˆ: ${file.name}`, 'info');
                    
                    await processFile(file);
                    processedFiles++;
                    
                    log(`âœ… ${file.name} ä¸Šå‚³å®Œæˆ`, 'success');
                } catch (error) {
                    log(`âŒ ${file.name} ä¸Šå‚³å¤±æ•—: ${error.message}`, 'error');
                    processedFiles++;
                }
            }

            updateProgress(totalFiles, totalFiles, 'æ‰€æœ‰æª”æ¡ˆè™•ç†å®Œæˆï¼');
            log('ğŸ‰ ä¸Šå‚³ç¨‹åºå®Œæˆï¼', 'success');
            uploadBtn.disabled = false;
        }

        async function processFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        try {
                            const tableName = getTableName(file.name);
                            const fieldMapping = getFieldMapping(file.name);
                            const fieldMode = document.querySelector('input[name="fieldMode"]:checked').value;
                            
                            log(`ç›®æ¨™è¡¨æ ¼: ${tableName}`, 'info');

                            const transformedData = results.data.map(row => {
                                const newRow = {};
                                
                                if (fieldMode === 'selected') {
                                    // åªä¸Šå‚³é¸ä¸­çš„æ¬„ä½
                                    Object.entries(fieldMapping).forEach(([csvField, dbField]) => {
                                        const checkbox = document.getElementById(`field_${file.name}_${csvField}`);
                                        if (checkbox && checkbox.checked) {
                                            let value = row[csvField];
                                            value = transformValue(value, csvField);
                                            newRow[dbField] = value;
                                        }
                                    });
                                } else {
                                    // ä¸Šå‚³æ‰€æœ‰å°æ‡‰æ¬„ä½
                                    if (Object.keys(fieldMapping).length > 0) {
                                        Object.entries(fieldMapping).forEach(([csvField, dbField]) => {
                                            let value = row[csvField];
                                            value = transformValue(value, csvField);
                                            newRow[dbField] = value;
                                        });
                                    } else {
                                        // æ²’æœ‰å°æ‡‰è¨­å®šï¼Œç›´æ¥è¤‡è£½æ‰€æœ‰æ¬„ä½
                                        Object.keys(row).forEach(key => {
                                            newRow[key] = row[key];
                                        });
                                    }
                                }
                                
                                return newRow;
                            });

                            // æ‰¹æ¬¡ä¸Šå‚³è³‡æ–™
                            const batchSize = 1000;
                            for (let i = 0; i < transformedData.length; i += batchSize) {
                                const batch = transformedData.slice(i, i + batchSize);
                                
                                const { error } = await supabase
                                    .from(tableName)
                                    .insert(batch);
                                
                                if (error) {
                                    throw error;
                                }
                                
                                log(`${tableName}: å·²ä¸Šå‚³ ${Math.min(i + batchSize, transformedData.length)}/${transformedData.length} ç­†è³‡æ–™`, 'info');
                            }
                            
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: (error) => {
                        reject(new Error(`CSV è§£æéŒ¯èª¤: ${error.message}`));
                    }
                });
            });
        }

        // è³‡æ–™è½‰æ›å‡½æ•¸
        function transformValue(value, csvField) {
            if (value !== undefined && value !== null && value !== '') {
                // æ•¸å­—æ¬„ä½è½‰æ›
                if (csvField.includes('æˆ¿') || csvField.includes('å»³') || csvField.includes('è¡›') || 
                    csvField.includes('åƒ¹') || csvField.includes('å±‹é½¡') || csvField.includes('åˆ†æ¯') || csvField.includes('åˆ†å­')) {
                    const numValue = parseFloat(value);
                    return isNaN(numValue) ? null : numValue;
                }
                // æ—¥æœŸæ¬„ä½è½‰æ›
                else if (csvField.includes('æ—¥æœŸ') || csvField.includes('å¹´æœˆæ—¥')) {
                    if (value && value.length >= 7) {
                        try {
                            // è½‰æ› 1130101 æ ¼å¼ç‚º 2024-01-01
                            const year = parseInt(value.substring(0, 3)) + 1911;
                            const month = value.substring(3, 5);
                            const day = value.substring(5, 7);
                            return `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                        } catch (e) {
                            // å¦‚æœè½‰æ›å¤±æ•—ï¼Œä¿æŒåŸå€¼
                            return value;
                        }
                    }
                }
            }
            return value;
        }åƒ¹') || csvField.includes('å±‹é½¡') || csvField.includes('åˆ†æ¯') || csvField.includes('åˆ†å­')) {
                                                const numValue = parseFloat(value);
                                                value = isNaN(numValue) ? null : numValue;
                                            }
                                            // æ—¥æœŸæ¬„ä½è½‰æ›
                                            else if (csvField.includes('æ—¥æœŸ') || csvField.includes('å¹´æœˆæ—¥')) {
                                                if (value && value.length >= 7) {
                                                    try {
                                                        // è½‰æ› 1130101 æ ¼å¼ç‚º 2024-01-01
                                                        const year = parseInt(value.substring(0, 3)) + 1911;
                                                        const month = value.substring(3, 5);
                                                        const day = value.substring(5, 7);
                                                        value = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                                                    } catch (e) {
                                                        // å¦‚æœè½‰æ›å¤±æ•—ï¼Œä¿æŒåŸå€¼
                                                    }
                                                }
                                            }
                                        }
                                        
                                        newRow[dbField] = value;
                                    }
                                } else {
                                    // æ²’æœ‰ç‰¹å®šå°æ‡‰è¨­å®šï¼Œç›´æ¥è¤‡è£½æ‰€æœ‰æ¬„ä½
                                    Object.keys(row).forEach(key => {
                                        newRow[key] = row[key];
                                    });
                                }
                                
                                return newRow;
                            });

                            // æ‰¹æ¬¡ä¸Šå‚³è³‡æ–™
                            const batchSize = 1000;
                            for (let i = 0; i < transformedData.length; i += batchSize) {
                                const batch = transformedData.slice(i, i + batchSize);
                                
                                const { error } = await supabase
                                    .from(tableName)
                                    .insert(batch);
                                
                                if (error) {
                                    throw error;
                                }
                                
                                log(`${tableName}: å·²ä¸Šå‚³ ${Math.min(i + batchSize, transformedData.length)}/${transformedData.length} ç­†è³‡æ–™`, 'info');
                            }
                            
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: (error) => {
                        reject(new Error(`CSV è§£æéŒ¯èª¤: ${error.message}`));
                    }
                });
            });
        }
    </script>
</body>
</html>
