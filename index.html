<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 不動產資料上傳工具</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* Custom scrollbar for log */
        #log::-webkit-scrollbar { width: 8px; }
        #log::-webkit-scrollbar-track { background: #f1f1f1; }
        #log::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        #log::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h1 class="text-2xl font-bold mb-2 text-gray-800">Supabase 不動產資料上傳工具</h1>
            <p class="text-gray-600 mb-6">請填寫您的 Supabase 資訊，並選擇要上傳的實價登錄 CSV 檔案。</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="input-group">
                    <label for="url" class="block mb-2 text-sm font-medium text-gray-700">Supabase URL:</label>
                    <input type="text" id="url" placeholder="https://your-project-ref.supabase.co" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                <div class="input-group">
                    <label for="key" class="block mb-2 text-sm font-medium text-gray-700">Service Role Key:</label>
                    <input type="password" id="key" placeholder="您的 service_role key" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
            </div>

            <div class="mb-6">
                <label for="csvFiles" class="block mb-2 text-sm font-medium text-gray-700">選擇 CSV 檔案:</label>
                <input type="file" id="csvFiles" multiple accept=".csv" class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none">
            </div>

            <div class="flex space-x-2">
                <button onclick="startUpload()" id="uploadButton" class="flex-grow text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors">
                    開始上傳
                </button>
                <button onclick="clearLog()" class="text-white bg-gray-500 hover:bg-gray-600 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors">
                    清除日誌
                </button>
            </div>
            
            <div id="log-container" class="mt-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">上傳日誌:</h2>
                <div id="log" class="bg-gray-800 text-white font-mono text-sm p-4 rounded-lg h-64 overflow-y-auto"></div>
            </div>
        </div>
        <footer class="text-center text-gray-500 mt-4 text-sm">
            <p>V3.3 (floor level fix) - 此工具直接在您的瀏覽器中處理資料，不會將您的金鑰或資料傳送到第三方伺服器。</p>
        </footer>
    </div>

<script>
    const columnMapping = {
        '移轉編號': 'serial_number',
        '編號': 'serial_number',
        '鄉鎮市區': 'district', 
        '交易標的': 'transaction_target', 
        '土地位置建物門牌': 'address', 
        '土地移轉總面積平方公尺': 'land_area', 
        '都市土地使用分區': 'zoning', 
        '非都市土地使用分區': 'non_metropolis_land_use', 
        '非都市土地使用編定': 'non_metropolis_land_category', 
        '交易年月日': 'transaction_date', 
        '交易筆棟數': 'transaction_count_str', 
        '移轉層次': 'floor_level', 
        '總樓層數': 'total_floors', 
        '建物型態': 'building_type', 
        '主要用途': 'main_use', 
        '主要建材': 'main_materials', 
        '建築完成年月': 'completion_date', 
        '建物移轉總面積平方公尺': 'building_area', 
        '建物現況格局-房': 'room_count', 
        '建物現況格局-廳': 'hall_count', 
        '建物現況格局-衛': 'bathroom_count', 
        '建物現況格局-隔間': 'compartment', 
        '有無管理組織': 'management_org', 
        '總價元': 'total_price', 
        '單價元平方公尺': 'unit_price', 
        '車位類別': 'parking_type', 
        '車位移轉總面積平方公尺': 'parking_area', 
        '車位總價元': 'parking_price', 
        '備註': 'noted_detail', 
        '主建物面積': 'main_building_area', 
        '附屬建物面積': 'auxiliary_building_area', 
        '陽台面積': 'balcony_area', 
        '電梯': 'elevator',
        '建案名稱': 'building_name', '起造人': 'developer', '設計人': 'architect', '監造人': 'constructor',
        '租賃年月日': 'transaction_date', '租賃筆棟數': 'transaction_count_str', '租賃層次': 'floor_level', '月租金元': 'monthly_rent', '押金': 'security_deposit', '租期': 'rental_term', '含家具': 'has_furniture', '含設備': 'has_appliance', '含管理費': 'has_management_fee', '含網路': 'has_network', '含車位': 'has_parking', '車位月租金元': 'monthly_parking_rent',
        '交易標的 Grundstücksnummer': 'land_number', '都市土地使用分區 Nutzung': 'land_use_zoning', '非都市土地使用編定 Nutzung': 'land_use_type', '移轉面積㎡': 'transfer_land_area', '持分': 'land_proportion_share', '交易編號': 'transaction_id'
    };
    
    function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const time = new Date().toLocaleTimeString();
        const colorClass = { info: 'text-blue-300', success: 'text-green-400', error: 'text-red-400', warning: 'text-yellow-400' }[type];
        logDiv.innerHTML += `<div class="${colorClass}"><span class="text-gray-400">[${time}]</span> ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function clearLog() {
        document.getElementById('log').innerHTML = '';
        log('日誌已清除。', 'info');
    }

    function parseFilename(filename) {
        const match = filename.match(/([A-Z])_lvr_land_([abc])(?:_(\w+))?\.csv/i);
        if (!match) return null;
        const [_, city_code, trans_type, data_type_raw] = match;
        return { city_code: city_code.toUpperCase(), trans_type, data_type: data_type_raw || 'main' };
    }
    
    function cleanRecord(record, city_code, source_file) {
        let newRecord = { city_code, source_file };
        for (const key in record) {
            const newKey = columnMapping[key.trim()] || key.trim();
            newRecord[newKey] = record[key];
        }

        ['transaction_date', 'completion_date'].forEach(dateKey => {
            if (newRecord[dateKey] && typeof newRecord[dateKey] === 'string') {
                const dateStr = newRecord[dateKey].trim();
                if (dateStr.length === 7 && !isNaN(dateStr)) {
                    const year = parseInt(dateStr.substring(0, 3), 10) + 1911;
                    const month = dateStr.substring(3, 5);
                    const day = dateStr.substring(5, 7);
                    newRecord[dateKey] = `${year}-${month}-${day}`;
                } else if ((dateStr.length === 5 || dateStr.length === 6) && !isNaN(dateStr)) {
                     const year = parseInt(dateStr.substring(0, 3), 10) + 1911;
                     const month = dateStr.substring(3, 5);
                     newRecord[dateKey] = `${year}-${month}`;
                }
            } else if (newRecord[dateKey] && typeof newRecord[dateKey] === 'number') {
                 const dateStr = String(newRecord[dateKey]);
                 if (dateStr.length === 7) {
                    const year = parseInt(dateStr.substring(0, 3), 10) + 1911;
                    const month = dateStr.substring(3, 5);
                    const day = dateStr.substring(5, 7);
                    newRecord[dateKey] = `${year}-${month}-${day}`;
                 }
            }
        });
        
        const numericKeys = ['total_price', 'unit_price', 'land_area', 'building_area', 'room_count', 'hall_count', 'bathroom_count', 'parking_area', 'parking_price', 'main_building_area', 'auxiliary_building_area', 'balcony_area', 'monthly_rent', 'monthly_parking_rent'];
        numericKeys.forEach(numKey => {
             if (newRecord[numKey] !== undefined && newRecord[numKey] !== null) {
                const val = String(newRecord[numKey]).replace(/,/g, '');
                newRecord[numKey] = (val.trim() === '' || isNaN(parseFloat(val))) ? null : parseFloat(val);
            }
        });

        if(newRecord.total_floors !== undefined && newRecord.total_floors !== null) {
            const floorStr = String(newRecord.total_floors).replace('層', '');
            const floorMap = { '一': 1, '二': 2, '三': 3, '四': 4, '五': 5, '六': 6, '七': 7, '八': 8, '九': 9, '十': 10, '十一':11, '十二':12, '十三':13, '十四':14, '十五':15 };
            newRecord.total_floors = floorMap[floorStr] || (floorStr.trim() === '' || isNaN(parseInt(floorStr)) ? null : parseInt(floorStr));
        }
        
        // ** FIX: Convert Chinese numerals in 'floor_level' to Arabic numerals **
        if (newRecord.floor_level && typeof newRecord.floor_level === 'string') {
            let level = newRecord.floor_level.trim();
            // Only process if it's not '全'
            if (level !== '全') {
                const floorCharMap = {
                    '一層': '1', '二層': '2', '三層': '3', '四層': '4', '五層': '5',
                    '六層': '6', '七層': '7', '八層': '8', '九層': '9', '十層': '10',
                    '十一層': '11', '十二層': '12', '十三層': '13', '十四層': '14', '十五層': '15',
                    '十六層': '16', '十七層': '17', '十八層': '18', '十九層': '19', '二十層': '20'
                    // Can be extended as needed
                };
                
                // Handle comma-separated values like "三層,四層"
                const parts = level.split(/,|，/); // Split by English or Chinese comma
                const newParts = parts.map(part => {
                    const trimmedPart = part.trim();
                    return floorCharMap[trimmedPart] || trimmedPart; // If found in map, replace, otherwise keep original
                });
                
                newRecord.floor_level = newParts.join(',');
            }
        }
        
        return newRecord;
    }

    async function startUpload() {
        const url = document.getElementById('url').value.trim();
        const key = document.getElementById('key').value.trim();
        const files = document.getElementById('csvFiles').files;

        if (!url || !key) { return log('請填入 Supabase URL 和 Service Role Key。', 'error'); }
        if (files.length === 0) { return log('請選擇要上傳的 CSV 檔案。', 'error'); }
        
        document.getElementById('uploadButton').disabled = true;
        document.getElementById('uploadButton').innerText = '上傳中...';
        
        const supabaseClient = supabase.createClient(url, key);
        log('Supabase 客戶端初始化成功。', 'success');

        const CHUNK_SIZE = 500; 

        for (const file of files) {
            log(`-----------------------------------`, 'info');
            log(`處理檔案: ${file.name}`, 'info');

            const fileInfo = parseFilename(file.name);
            if (!fileInfo) {
                log(`檔名格式不符，跳過檔案: ${file.name}`, 'warning');
                continue;
            }

            const { city_code, trans_type, data_type } = fileInfo;
            
            let target_table;
            if (data_type === 'main') { target_table = `${trans_type}_transactions`; } 
            else if (data_type === 'build') { target_table = `${trans_type}_buildings`; }
            else if (data_type === 'land') { target_table = `${trans_type}_lands`; }
            else if (data_type === 'park') { target_table = `${trans_type}_parking`; }
            else { log(`未知的 data_type: ${data_type}，跳過。`, 'warning'); continue; }

            log(`目標資料表: ${target_table}`, 'info');

            try {
                const results = await new Promise((resolve, reject) => {
                    Papa.parse(file, { header: true, skipEmptyLines: true, complete: resolve, error: reject });
                });
                
                if (results.errors.length > 0) {
                     log(`CSV 解析錯誤: ${results.errors.map(e => e.message).join(', ')}`, 'error');
                     continue;
                }

                const cleanedRecords = results.data.map(record => cleanRecord(record, city_code, file.name));

                if (cleanedRecords.length === 0) {
                    log('檔案中無有效資料可上傳。', 'warning');
                    continue;
                }

                log(`總共 ${cleanedRecords.length} 筆紀錄，將以每批 ${CHUNK_SIZE} 筆的方式上傳。`, 'info');

                if (data_type === 'main') {
                    for (let i = 0; i < cleanedRecords.length; i += CHUNK_SIZE) {
                        const chunk = cleanedRecords.slice(i, i + CHUNK_SIZE);
                        log(`正在上傳主表資料，第 ${i + 1} - ${i + chunk.length} 筆...`, 'info');
                        const { error } = await supabaseClient.from(target_table).upsert(chunk, { onConflict: 'serial_number' });
                        if (error) throw error;
                    }
                    log(`主表資料上傳成功！`, 'success');
                } else {
                    const transaction_ids = [...new Set(cleanedRecords.map(r => r.transaction_id))].filter(Boolean);
                    if (transaction_ids.length > 0) {
                        log(`執行[先刪後插]：刪除 ${transaction_ids.length} 個相關交易紀錄...`, 'info');
                        const { error: deleteError } = await supabaseClient.from(target_table).delete().in('transaction_id', transaction_ids);
                        if (deleteError) throw new Error(`刪除舊資料失敗: ${deleteError.message}`);
                        log(`舊資料刪除成功，準備插入新資料...`, 'success');
                    }
                    
                    for (let i = 0; i < cleanedRecords.length; i += CHUNK_SIZE) {
                        const chunk = cleanedRecords.slice(i, i + CHUNK_SIZE);
                        log(`正在上傳附表資料，第 ${i + 1} - ${i + chunk.length} 筆...`, 'info');
                        const { error: insertError } = await supabaseClient.from(target_table).insert(chunk);
                        if (insertError) throw insertError;
                    }
                    log(`附表資料上傳成功！`, 'success');
                }
            } catch (error) {
                console.error("Error during file processing:", error);
                log(`處理檔案 ${file.name} 時發生錯誤: ${error.message}`, 'error');
            }
        }
        
        log(`-----------------------------------`, 'info');
        log('所有檔案處理完畢！', 'success');
        document.getElementById('uploadButton').disabled = false;
        document.getElementById('uploadButton').innerText = '開始上傳';
    }

</script>
</body>
</html>
