<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>不動產資料 CSV 上傳工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.38.0/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #5a6fd8;
        }

        .upload-area.dragover {
            background: #f0f4ff;
            border-color: #4c63d2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #666;
            font-size: 0.9em;
        }

        .file-list {
            margin-bottom: 30px;
        }

        .file-item {
            background: #f1f3f4;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            display: flex;
            align-items: center;
        }

        .file-icon {
            margin-right: 15px;
            font-size: 1.5em;
            color: #667eea;
        }

        .file-details h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .file-details p {
            color: #666;
            font-size: 0.9em;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .remove-btn:hover {
            background: #ff3742;
        }

        .upload-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
            margin-bottom: 20px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            color: #333;
            font-weight: bold;
        }

        .log-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .log-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-success { color: #27ae60; }
        .log-error { color: #e74c3c; }
        .log-info { color: #3498db; }
        .log-warning { color: #f39c12; }

        .hidden {
            display: none;
        }

        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏠 不動產資料上傳工具</h1>
            <p>輕鬆上傳您的 CSV 檔案到 Supabase 資料庫</p>
        </div>

        <div class="config-section">
            <h3>📋 Supabase 設定</h3>
            <div class="input-group">
                <label for="supabaseUrl">Supabase URL</label>
                <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" />
            </div>
            <div class="input-group">
                <label for="supabaseKey">Supabase API Key</label>
                <input type="password" id="supabaseKey" placeholder="your-anon-key" />
            </div>
        </div>

        <div class="config-section">
            <h3>🎯 欄位篩選設定</h3>
            <div class="input-group">
                <label>
                    <input type="radio" name="fieldMode" value="all" checked /> 
                    上傳所有欄位
                </label>
            </div>
            <div class="input-group">
                <label>
                    <input type="radio" name="fieldMode" value="selected" /> 
                    只上傳選定欄位
                </label>
            </div>
            <div id="fieldSelection" style="display: none; margin-top: 20px;">
                <p style="color: #666; margin-bottom: 15px;">請選擇要上傳的欄位（先選擇檔案後會顯示可選欄位）</p>
                <div id="fieldCheckboxes"></div>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">📁</div>
            <div class="upload-text">拖拉 CSV 檔案到這裡</div>
            <div class="upload-hint">或點擊選擇檔案 (支援多檔案選擇)</div>
            <input type="file" id="fileInput" multiple accept=".csv" />
        </div>

        <div class="file-list" id="fileList"></div>

        <button class="upload-btn" id="uploadBtn" disabled>開始上傳資料 🚀</button>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">準備上傳...</div>
        </div>

        <div class="log-container" id="logContainer">
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let supabase = null;

        // 根據文件的欄位對應表
        const fieldMappings = {
            // 中古交易主表 (a_lvr_land_a.csv)
            'a_lvr_land_a.csv': {
                '編號': '編號',
                '鄉鎮市區': '行政區', 
                '交易標的': '交易標的',
                '土地位置建物門牌': '地址',
                '交易年月日': '交易日',
                '交易筆棟數': '交易筆棟數',
                '移轉層次': '樓層',
                '建物型態': '建物型態',
                '主要用途': '主要用途',
                '建物移轉總面積平方公尺': '產權面積(房車)',
                '建物現況格局-房': '房數',
                '建物現況格局-廳': '廳數',
                '建物現況格局-衛': '衛浴數',
                '總價元': '交易總價',
                '車位類別': '車位類別',
                '車位移轉總面積平方公尺': '車位總面積',
                '車位總價元': '車位總價',
                '備註': '備註',
                '主建物面積': '主建物面積',
                '附屬建物面積': '附屬建物面積',
                '陽台面積': '陽台面積'
            },
            // 預售交易主表 (a_lvr_land_b.csv)
            'a_lvr_land_b.csv': {
                '編號': '編號',
                '鄉鎮市區': '行政區',
                '交易標的': '交易標的', 
                '土地位置建物門牌': '地址',
                '交易年月日': '交易日',
                '交易筆棟數': '交易筆棟數',
                '移轉層次': '樓層',
                '建物型態': '建物型態',
                '主要用途': '主要用途',
                '建物移轉總面積平方公尺': '產權面積(房車)',
                '建物現況格局-房': '房數',
                '建物現況格局-廳': '廳數',
                '建物現況格局-衛': '衛浴數',
                '總價元': '交易總價',
                '車位類別': '車位類別',
                '車位移轉總面積平方公尺': '車位總面積',
                '車位總價元': '車位總價',
                '備註': '備註',
                '建案名稱': '建案名稱',
                '棟及號': '戶別',
                '解約情形': '解約情形'
            },
            // 租賃交易主表 (a_lvr_land_c.csv)
            'a_lvr_land_c.csv': {
                '編號': '編號',
                '鄉鎮市區': '行政區',
                '交易標的': '交易標的',
                '土地位置建物門牌': '地址',
                '租賃年月日': '交易日',
                '租賃筆棟數': '交易筆棟數',
                '租賃層次': '樓層',
                '建物型態': '建物型態',
                '主要用途': '主要用途',
                '建物總面積平方公尺': '租賃面積',
                '建物現況格局-房': '房數',
                '建物現況格局-廳': '廳數',
                '建物現況格局-衛': '衛浴數',
                '總額元': '交易總價',
                '車位類別': '車位類別',
                '車位面積平方公尺': '車位總面積',
                '車位總額元': '車位總價',
                '備註': '備註',
                '出租型態': '出租型態',
                '租賃期間': '租賃期間',
                '附屬設備': '附屬設備',
                '租賃住宅服務': '租賃住宅服務'
            },
            // 建物交易附表
            'a_lvr_land_a_build.csv': {
                '編號': '編號',
                '屋齡': '交易屋齡',
                '主要建材': '結構',
                '建築完成日期': '完工日',
                '總層數': '總樓層',
                '移轉情形': '移轉情形'
            },
            'a_lvr_land_c_build.csv': {
                '編號': '編號',
                '屋齡': '交易屋齡',
                '主要建材': '結構',
                '建築完成日期': '完工日',
                '總層數': '總樓層',
                '移轉情形': '移轉情形'
            },
            // 土地交易附表
            'a_lvr_land_a_land.csv': {
                '編號': '編號',
                '土地位置': '地號(段)',
                '地號': '地號',
                '土地移轉面積平方公尺': '土地持分面積',
                '權利人持分分母': '持分分母',
                '權利人持分分子': '持分分子',
                '使用分區或編定': '使用分區'
            },
            'a_lvr_land_b_land.csv': {
                '編號': '編號',
                '土地位置': '地號(段)',
                '地號': '地號',
                '土地移轉面積平方公尺': '土地持分面積',
                '權利人持分分母': '持分分母',
                '權利人持分分子': '持分分子',
                '使用分區或編定': '使用分區'
            },
            'a_lvr_land_c_land.csv': {
                '編號': '編號',
                '土地位置': '地號(段)',
                '地號': '地號',
                '土地移轉面積平方公尺': '土地租賃面積',
                '使用分區或編定': '使用分區'
            },
            // 車位交易附表
            'a_lvr_land_a_park.csv': {
                '編號': '編號',
                '車位類別': '車位類別',
                '車位價格': '車位價格',
                '車位面積平方公尺': '車位面積',
                '車位所在樓層': '車位樓層'
            },
            'a_lvr_land_b_park.csv': {
                '編號': '編號',
                '車位類別': '車位類別',
                '車位價格': '車位價格',
                '車位面積平方公尺': '車位面積',
                '車位所在樓層': '車位樓層'
            },
            'a_lvr_land_c_park.csv': {
                '編號': '編號',
                '車位類別': '車位類別',
                '車位價格': '車位價格',
                '車位面積平方公尺': '車位面積',
                '車位所在樓層': '車位樓層'
            }
        };

        // 根據檔案名稱決定使用哪個欄位對應
        function getFieldMapping(fileName) {
            return fieldMappings[fileName] || {};
        }

        // DOM 元素
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const logContainer = document.getElementById('logContainer');
        const logContent = document.getElementById('logContent');
        const supabaseUrl = document.getElementById('supabaseUrl');
        const supabaseKey = document.getElementById('supabaseKey');

        // 事件監聽器
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);
        uploadBtn.addEventListener('click', startUpload);
        supabaseUrl.addEventListener('input', checkConfig);
        supabaseKey.addEventListener('input', checkConfig);
        
        // 欄位選擇模式切換
        document.querySelectorAll('input[name="fieldMode"]').forEach(radio => {
            radio.addEventListener('change', showFieldSelection);
        });

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.name.endsWith('.csv'));
            addFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            files.forEach(file => {
                if (!selectedFiles.find(f => f.name === file.name)) {
                    selectedFiles.push(file);
                }
            });
            renderFileList();
            checkConfig();
        }

        function removeFile(fileName) {
            selectedFiles = selectedFiles.filter(f => f.name !== fileName);
            renderFileList();
            checkConfig();
        }

        function renderFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';
                
                const fileIcon = document.createElement('div');
                fileIcon.className = 'file-icon';
                fileIcon.textContent = '📄';
                
                const fileDetails = document.createElement('div');
                fileDetails.className = 'file-details';
                fileDetails.innerHTML = `
                    <h4>${file.name}</h4>
                    <p>${(file.size / 1024).toFixed(1)} KB</p>
                `;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '移除';
                removeBtn.onclick = () => removeFile(file.name);
                
                fileInfo.appendChild(fileIcon);
                fileInfo.appendChild(fileDetails);
                fileItem.appendChild(fileInfo);
                fileItem.appendChild(removeBtn);
                fileList.appendChild(fileItem);
            });
            
            // 更新欄位選擇框
            updateFieldCheckboxes();
        }

        function checkConfig() {
            const hasUrl = supabaseUrl.value.trim();
            const hasKey = supabaseKey.value.trim();
            const hasFiles = selectedFiles.length > 0;
            
            uploadBtn.disabled = !(hasUrl && hasKey && hasFiles);
            
            if (hasUrl && hasKey) {
                try {
                    supabase = window.supabase.createClient(supabaseUrl.value.trim(), supabaseKey.value.trim());
                } catch (error) {
                    log('設定錯誤: ' + error.message, 'error');
                }
            }
        }

        function log(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logContent.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            if (logContainer.style.display === 'none') {
                logContainer.style.display = 'block';
            }
        }

        function updateProgress(current, total, message) {
            const percentage = (current / total) * 100;
            progressFill.style.width = percentage + '%';
            progressText.textContent = message;
        }

        async function startUpload() {
            if (!supabase) {
                log('請先設定 Supabase 連線資訊', 'error');
                return;
            }

            uploadBtn.disabled = true;
            progressContainer.style.display = 'block';
            logContent.innerHTML = '';
            
            let totalFiles = selectedFiles.length;
            let processedFiles = 0;

            log('開始上傳程序...', 'info');

            for (const file of selectedFiles) {
                try {
                    updateProgress(processedFiles, totalFiles, `處理檔案: ${file.name}`);
                    log(`處理檔案: ${file.name}`, 'info');
                    
                    await processFile(file);
                    processedFiles++;
                    
                    log(`✅ ${file.name} 上傳完成`, 'success');
                } catch (error) {
                    log(`❌ ${file.name} 上傳失敗: ${error.message}`, 'error');
                    processedFiles++;
                }
            }

            updateProgress(totalFiles, totalFiles, '所有檔案處理完成！');
            log('🎉 上傳程序完成！', 'success');
            uploadBtn.disabled = false;
        }

        async function processFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        try {
                            const tableName = getTableName(file.name);
                            const fieldMapping = getFieldMapping(file.name);
                            const fieldMode = document.querySelector('input[name="fieldMode"]:checked').value;
                            
                            log(`目標表格: ${tableName}`, 'info');

                            const transformedData = results.data.map(row => {
                                const newRow = {};
                                
                                if (fieldMode === 'selected') {
                                    // 只上傳選中的欄位
                                    Object.entries(fieldMapping).forEach(([csvField, dbField]) => {
                                        const checkbox = document.getElementById(`field_${file.name}_${csvField}`);
                                        if (checkbox && checkbox.checked) {
                                            let value = row[csvField];
                                            value = transformValue(value, csvField);
                                            newRow[dbField] = value;
                                        }
                                    });
                                } else {
                                    // 上傳所有對應欄位
                                    if (Object.keys(fieldMapping).length > 0) {
                                        Object.entries(fieldMapping).forEach(([csvField, dbField]) => {
                                            let value = row[csvField];
                                            value = transformValue(value, csvField);
                                            newRow[dbField] = value;
                                        });
                                    } else {
                                        // 沒有對應設定，直接複製所有欄位
                                        Object.keys(row).forEach(key => {
                                            newRow[key] = row[key];
                                        });
                                    }
                                }
                                
                                return newRow;
                            });

                            // 批次上傳資料
                            const batchSize = 1000;
                            for (let i = 0; i < transformedData.length; i += batchSize) {
                                const batch = transformedData.slice(i, i + batchSize);
                                
                                const { error } = await supabase
                                    .from(tableName)
                                    .insert(batch);
                                
                                if (error) {
                                    throw error;
                                }
                                
                                log(`${tableName}: 已上傳 ${Math.min(i + batchSize, transformedData.length)}/${transformedData.length} 筆資料`, 'info');
                            }
                            
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: (error) => {
                        reject(new Error(`CSV 解析錯誤: ${error.message}`));
                    }
                });
            });
        }

        // 資料轉換函數
        function transformValue(value, csvField) {
            if (value !== undefined && value !== null && value !== '') {
                // 數字欄位轉換
                if (csvField.includes('房') || csvField.includes('廳') || csvField.includes('衛') || 
                    csvField.includes('價') || csvField.includes('屋齡') || csvField.includes('分母') || csvField.includes('分子')) {
                    const numValue = parseFloat(value);
                    return isNaN(numValue) ? null : numValue;
                }
                // 日期欄位轉換
                else if (csvField.includes('日期') || csvField.includes('年月日')) {
                    if (value && value.length >= 7) {
                        try {
                            // 轉換 1130101 格式為 2024-01-01
                            const year = parseInt(value.substring(0, 3)) + 1911;
                            const month = value.substring(3, 5);
                            const day = value.substring(5, 7);
                            return `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                        } catch (e) {
                            // 如果轉換失敗，保持原值
                            return value;
                        }
                    }
                }
            }
            return value;
        }價') || csvField.includes('屋齡') || csvField.includes('分母') || csvField.includes('分子')) {
                                                const numValue = parseFloat(value);
                                                value = isNaN(numValue) ? null : numValue;
                                            }
                                            // 日期欄位轉換
                                            else if (csvField.includes('日期') || csvField.includes('年月日')) {
                                                if (value && value.length >= 7) {
                                                    try {
                                                        // 轉換 1130101 格式為 2024-01-01
                                                        const year = parseInt(value.substring(0, 3)) + 1911;
                                                        const month = value.substring(3, 5);
                                                        const day = value.substring(5, 7);
                                                        value = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                                                    } catch (e) {
                                                        // 如果轉換失敗，保持原值
                                                    }
                                                }
                                            }
                                        }
                                        
                                        newRow[dbField] = value;
                                    }
                                } else {
                                    // 沒有特定對應設定，直接複製所有欄位
                                    Object.keys(row).forEach(key => {
                                        newRow[key] = row[key];
                                    });
                                }
                                
                                return newRow;
                            });

                            // 批次上傳資料
                            const batchSize = 1000;
                            for (let i = 0; i < transformedData.length; i += batchSize) {
                                const batch = transformedData.slice(i, i + batchSize);
                                
                                const { error } = await supabase
                                    .from(tableName)
                                    .insert(batch);
                                
                                if (error) {
                                    throw error;
                                }
                                
                                log(`${tableName}: 已上傳 ${Math.min(i + batchSize, transformedData.length)}/${transformedData.length} 筆資料`, 'info');
                            }
                            
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: (error) => {
                        reject(new Error(`CSV 解析錯誤: ${error.message}`));
                    }
                });
            });
        }
    </script>
</body>
</html>
