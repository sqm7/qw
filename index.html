<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>不動產批次上傳工具 - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
               
[cite_start][cite: 1]      colors: {
                        'dark-bg': '#1a1d29',
                        'dark-card': '#252836',
                        'dark-sidebar': '#1f2937',
                   
[cite_start][cite: 2, 3]      'cyan-accent': '#06b6d4',
                        'cyan-light': '#67e8f9',
                        'purple-accent': '#8b5cf6',
                        'orange-accent': '#f59e0b'
                   
[cite_start][cite: 3, 4]  }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Inter', sans-serif;
[cite_start][cite: 4, 5] background: linear-gradient(135deg, #1a1d29 0%, #252836 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(37, 40, 54, 0.8);
[cite_start][cite: 5, 6] backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-border {
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
[cite_start][cite: 6, 7] padding: 1px;
            border-radius: 12px;
        }
        
        .gradient-border-inner {
            background: #252836;
[cite_start][cite: 7, 8] border-radius: 11px;
            padding: 1.5rem;
        }
        
        .status-indicator {
            width: 8px;
[cite_start][cite: 8, 9] height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background: #10b981;
[cite_start][cite: 9, 10] }
        .status-offline { background: #ef4444;
[cite_start][cite: 10, 11] }
        .status-warning { background: #f59e0b;
[cite_start][cite: 11, 12] }
        
        .progress-ring {
            transform: rotate(-90deg);
[cite_start][cite: 12, 13] }
        
        .progress-ring-circle {
            stroke-dasharray: 251.2;
[cite_start][cite: 13, 14] stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        
        .cyber-glow {
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
[cite_start][cite: 14, 15] }
        
        .terminal {
            background: #0f172a;
[cite_start][cite: 15, 16] border: 1px solid #334155;
            font-family: 'Courier New', monospace;
            color: #64748b;
[cite_start][cite: 16, 17] }
        
        .terminal-success { color: #10b981;
[cite_start][cite: 17, 18] }
        .terminal-error { color: #ef4444;
[cite_start][cite: 18, 19] }
        .terminal-warning { color: #f59e0b;
[cite_start][cite: 19, 20] }
        .terminal-info { color: #06b6d4;
[cite_start][cite: 20, 21] }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
[cite_start][cite: 21, 22] }
            50% { box-shadow: 0 0 30px rgba(6, 182, 212, 0.6);
[cite_start][cite: 22, 23] }
        }
        
        .animate-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
[cite_start][cite: 23, 24] }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
[cite_start][cite: 24, 25] border: 1px solid rgba(6, 182, 212, 0.2);
        }
    </style>
</head>
<body class="bg-dark-bg text-white">
    <div class="bg-dark-sidebar border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-gradient-to-r from-cyan-accent to-purple-accent rounded-lg flex items-center justify-center">
                    <svg 
[cite_start][cite: 25, 26] class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                </div>
    
[cite_start][cite: 26, 27]             <div>
                    <h1 class="text-xl font-bold text-white">不動產批次上傳工具</h1>
                    <p class="text-sm text-gray-400">Real Estate Batch Upload Dashboard v4.5</p>
                </div>
            </div>
          
[cite_start][cite: 27, 28]   <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <span class="status-indicator" id="connectionStatus"></span>
                    <span class="text-sm text-gray-400" id="connectionText">未連線</span>
                </div>
               
[cite_start][cite: 28, 29]  <div class="text-right">
                    <div class="text-sm font-medium text-white" id="currentTime"></div>
                    <div class="text-xs text-gray-400">系統時間</div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex">
       
[cite_start][cite: 29, 30]  <div class="w-64 bg-dark-sidebar border-r border-gray-700 min-h-screen p-4">
            <nav class="space-y-2">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">主要功能</div>
                <a href="#connection" class="flex items-center space-x-3 px-3 py-2 rounded-lg bg-cyan-accent/10 text-cyan-accent border border-cyan-accent/20">
                    <svg 
[cite_start][cite: 30, 31] class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 1.79 4 4 4h8c0-2.21-1.79-4-4-4H8c-2.21 0-4-1.79-4-4zm0 0V4c0-2.21 1.79-4 4-4h4c2.21 0 4 1.79 4 4v3M4 7h16"></path>
                    </svg>
                    <span>資料庫連線</span>
         
[cite_start][cite: 31, 32]        </a>
                <a href="#upload" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-700/50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 
[cite_start][cite: 32, 33] 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <span>檔案上傳</span>
                </a>
                <a href="#monitor" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-700/50">
             
[cite_start][cite: 33, 34]        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
           
[cite_start][cite: 34, 35]          </svg>
                    <span>監控面板</span>
                </a>
                
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4 mt-8">系統狀態</div>
                
[cite_start][cite: 35, 36] <div class="space-y-3">
                    <div class="flex items-center justify-between px-3 py-2">
                        <span class="text-sm text-gray-400">CPU 使用率</span>
                        <span class="text-sm text-cyan-accent">23%</span>
                    </div>
 
[cite_start][cite: 36, 37]                    <div class="flex items-center justify-between px-3 py-2">
                        <span class="text-sm text-gray-400">記憶體</span>
                        <span class="text-sm text-purple-accent">1.2GB</span>
                    </div>
    
[cite_start][cite: 37, 38]                 <div class="flex items-center justify-between px-3 py-2">
                        <span class="text-sm text-gray-400">網路</span>
                        <span class="text-sm text-green-400">正常</span>
                    </div>
       
[cite_start][cite: 38, 39]          </div>
            </nav>
        </div>

        <div class="flex-1 p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-card 
[cite_start][cite: 39, 40] rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-400">總處理檔案</p>
                      
[cite_start][cite: 40, 41]       <p class="text-2xl font-bold text-white" id="totalFiles">0</p>
                        </div>
                        <div class="w-12 h-12 bg-cyan-accent/20 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-cyan-accent" fill="none" stroke="currentColor" viewBox="0 
[cite_start][cite: 41, 42] 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
              
[cite_start][cite: 42, 43]           </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <span class="text-xs text-green-400">+12%</span>
                     
[cite_start][cite: 43, 44]    <span class="text-xs text-gray-400 ml-2">vs 上次</span>
                    </div>
                </div>

                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
               
[cite_start][cite: 44, 45]          <div>
                            <p class="text-sm text-gray-400">成功上傳</p>
                            <p class="text-2xl font-bold text-white" id="successCount">0</p>
                        </div>
     
[cite_start][cite: 45, 46]                    <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 
[cite_start][cite: 46, 47] 13l4 4L19 7"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
   
[cite_start][cite: 47, 48]                      <span class="text-xs text-green-400">+8%</span>
                        <span class="text-xs text-gray-400 ml-2">成功率</span>
                    </div>
                </div>

              
[cite_start][cite: 48, 49]   <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-400">處理錯誤</p>
                  
[cite_start][cite: 49, 50]           <p class="text-2xl font-bold text-white" id="errorCount">0</p>
                        </div>
                        <div class="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 
[cite_start][cite: 50, 51] text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                  
[cite_start][cite: 51, 52]       </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <span class="text-xs text-red-400">-2%</span>
                        <span 
[cite_start][cite: 52, 53] class="text-xs text-gray-400 ml-2">錯誤率</span>
                    </div>
                </div>

                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
                    
[cite_start][cite: 53, 54]     <div>
                            <p class="text-sm text-gray-400">處理速度</p>
                            <p class="text-2xl font-bold text-white" id="processingSpeed">0</p>
                            <p class="text-xs text-gray-400">records/sec</p>
    
[cite_start][cite: 54, 55]                     </div>
                        <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            
[cite_start][cite: 55, 56]                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
  
[cite_start][cite: 56, 57]               </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
      
[cite_start][cite: 57, 58]               <div class="glass-card rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold text-white flex items-center">
                     
[cite_start][cite: 58, 59]            <svg class="w-5 h-5 text-cyan-accent mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 1.79 4 4 4h8c0-2.21-1.79-4-4-4H8c-2.21 0-4-1.79-4-4zm0 0V4c0-2.21 1.79-4 4-4h4c2.21 0 4 1.79 4 4v3M4 7h16"></path>
                       
[cite_start][cite: 59, 60]          </svg>
                                Supabase 資料庫連線
                            </h2>
                            <div class="flex 
[cite_start][cite: 60, 61] items-center space-x-2">
                                <span class="status-indicator status-offline" id="dbStatus"></span>
                                <span class="text-sm text-gray-400">資料庫狀態</span>
                            </div>
  
[cite_start][cite: 61, 62]                       </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                         
[cite_start][cite: 62, 63]    <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Supabase URL</label>
                                <input type="text" id="supabaseUrl" 
                        
[cite_start][cite: 63, 64]                class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-cyan-accent focus:ring-1 focus:ring-cyan-accent transition-colors" 
                                       placeholder="https://your-project-ref.supabase.co">
                            </div>
     
[cite_start][cite: 64, 65]                        <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Service Role Key</label>
                                <input type="password" id="supabaseKey" 
   
[cite_start][cite: 65, 66]                                     class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-cyan-accent focus:ring-1 focus:ring-cyan-accent transition-colors" 
                                       placeholder="your-service-role-key">
            
[cite_start][cite: 66, 67]                 </div>
                        </div>
                        
                        <button id="testConnectionButton" 
          
[cite_start][cite: 67, 68]                       class="bg-gradient-to-r from-cyan-accent to-purple-accent text-white px-6 py-3 rounded-lg font-medium hover:shadow-lg hover:shadow-cyan-accent/25 transition-all duration-300">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             
[cite_start][cite: 68, 69]    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            測試連線
                        </button>
           
[cite_start][cite: 69, 70]          </div>

                    <div class="glass-card rounded-xl p-6">
                        <h2 class="text-lg font-semibold text-white mb-6 flex items-center">
              
[cite_start][cite: 70, 71]               <svg class="w-5 h-5 text-cyan-accent mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        
[cite_start][cite: 71, 72]     </svg>
                            檔案批次上傳
                        </h2>
                        
                    
[cite_start][cite: 72, 73]     <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center mb-6 hover:border-cyan-accent transition-colors">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 
[cite_start][cite: 73, 74] 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="text-gray-300 mb-2">選擇包含所有資料的總資料夾</p>
                            <p class="text-sm text-gray-400 mb-4">系統將自動掃描並排序所有檔案</p>
       
[cite_start][cite: 74, 75]                      <button id="selectFoldersButton" 
                                    class="bg-gradient-to-r from-cyan-accent to-blue-500 text-white px-8 py-3 rounded-lg font-medium hover:shadow-lg hover:shadow-cyan-accent/25 transition-all duration-300">
                              
[cite_start][cite: 75, 76]   選擇資料夾
                            </button>
                        </div>

                        <div id="fileListContainer" class="hidden">
                    
[cite_start][cite: 76, 77]         <div class="bg-gray-800 rounded-lg p-4 mb-4">
                                <h3 class="text-sm font-medium text-gray-300 mb-3">偵測到的檔案</h3>
                                <div id="fileList" class="space-y-2 max-h-40 overflow-y-auto"></div>
                
[cite_start][cite: 77, 78]             </div>
                            
                            <button id="startUploadButton" 
                              
[cite_start][cite: 78, 79]       class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-lg font-semibold hover:shadow-lg hover:shadow-green-500/25 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" 
[cite_start][cite: 79, 80] stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                開始全自動上傳
                   
[cite_start][cite: 80, 81]          </button>
                        </div>
                    </div>
                </div>

                [cite_start][cite: 81, 82]      <div class="space-y-6">
                    <div class="glass-card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">上傳進度</h3>
                    
[cite_start][cite: 82, 83]     <div class="flex items-center justify-center">
                            <div class="relative w-32 h-32">
                                <svg class="w-32 h-32 progress-ring" viewBox="0 0 84 84">
                       
[cite_start][cite: 83, 84]              <circle cx="42" cy="42" r="40" stroke="#374151" stroke-width="4" fill="none"/>
                                    <circle cx="42" cy="42" r="40" stroke="#06b6d4" stroke-width="4" fill="none" 
                                      
[cite_start][cite: 84, 85]       class="progress-ring-circle" id="progressCircle"/>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                        
[cite_start][cite: 85, 86]             <div class="text-center">
                                        <div class="text-2xl font-bold text-white" id="progressPercent">0%</div>
                                        <div class="text-xs text-gray-400">完成度</div>
 
[cite_start][cite: 86, 87]                                    </div>
                                </div>
                            </div>
     
[cite_start][cite: 87, 88]                    </div>
                        <div class="mt-4 text-center">
                            <p class="text-sm text-gray-400" id="progressStatus">等待開始...</p>
                        
[cite_start][cite: 88, 89]     <p class="text-xs text-gray-500 mt-1" id="currentFileName"></p>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6">
  
[cite_start][cite: 89, 90]                       <h3 class="text-lg font-semibold text-white mb-4">即時統計</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                  
[cite_start][cite: 90, 91]               <span class="text-sm text-gray-400">新增記錄</span>
                                <span class="text-sm font-medium text-green-400" id="newRecords">0</span>
                            </div>
                    
[cite_start][cite: 91, 92]         <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-400">更新記錄</span>
                                <span class="text-sm font-medium text-blue-400" id="updatedRecords">0</span>
                   
[cite_start][cite: 92, 93]          </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-400">跳過記錄</span>
                          
[cite_start][cite: 93, 94]       <span class="text-sm font-medium text-gray-400" id="skippedRecords">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                               
[cite_start][cite: 94, 95]  <span class="text-sm text-gray-400">錯誤記錄</span>
                                <span class="text-sm font-medium text-red-400" id="errorRecords">0</span>
                            </div>
                        </div>
         
[cite_start][cite: 95, 96]            </div>

                    <div class="glass-card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">系統狀態</h3>
               
[cite_start][cite: 96, 97]          <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                         
[cite_start][cite: 97, 98]            <span class="status-indicator status-online"></span>
                                    <span class="text-sm text-gray-300">前端服務</span>
                                </div>
                 
[cite_start][cite: 98, 99]                <span class="text-xs text-green-400">運行中</span>
                            </div>
                            <div class="flex items-center justify-between">
                        
[cite_start][cite: 99, 100]         <div class="flex items-center">
                                    <span class="status-indicator" id="dbStatusIndicator"></span>
                                    <span class="text-sm text-gray-300">資料庫</span>
              
[cite_start][cite: 100, 101]                   </div>
                                <span class="text-xs text-gray-400" id="dbStatusText">未連線</span>
                            </div>
                   
[cite_start][cite: 101, 102]          <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="status-indicator status-online"></span>
                
[cite_start][cite: 102, 103]                     <span class="text-sm text-gray-300">檔案系統</span>
                                </div>
                                <span class="text-xs text-green-400">正常</span>
            
[cite_start][cite: 103, 104]                 </div>
                        </div>
                    </div>
                </div>
            </div>

            
[cite_start][cite: 104, 105] <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                  
[cite_start][cite: 105, 106]       <h3 class="text-lg font-semibold text-white flex items-center">
                            <svg class="w-5 h-5 text-cyan-accent mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 
[cite_start][cite: 106, 107] 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            執行日誌
                        </h3>
               
[cite_start][cite: 107, 108]          <button class="text-xs text-gray-400 hover:text-white" onclick="clearLogs('status')">清除</button>
                    </div>
                    <div id="statusContainer" class="terminal rounded-lg p-4 h-80 overflow-y-auto">
                        <div class="text-gray-400">等待操作...</div>
                
[cite_start][cite: 108, 109]     </div>
                </div>

                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                  
[cite_start][cite: 109, 110]       <h3 class="text-lg font-semibold text-white flex items-center">
                            <svg class="w-5 h-5 text-red-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
   
[cite_start][cite: 110, 111]                          </svg>
                            錯誤日誌
                        </h3>
                       
[cite_start][cite: 111, 112]  <button class="text-xs text-gray-400 hover:text-white" onclick="clearLogs('error')">清除</button>
                    </div>
                    <div id="errorLogContainer" class="terminal rounded-lg p-4 h-80 overflow-y-auto">
                        <div class="text-gray-400">無錯誤記錄</div>
                    </div>
    
[cite_start][cite: 112, 113]             </div>
            </div>
        </div>
    </div>

    <script>
        // --- 設定與常數 ---
        const counties = { 'A': '臺北市', 'B': '臺中市', 'C': '基隆市', 'D': '臺南市', 'E': '高雄市', 'F': '新北市', 'G': '宜蘭縣', 'H': '桃園市', 'I': '嘉義市', 'J': '新竹縣', 'K': '苗栗縣', 'M': '南投縣', 'N': '彰化縣', 'O': '新竹市', 'P': '雲林縣', 'Q': '嘉義縣', 'T': '屏東縣', 'U': '花蓮縣', 'V': 
[cite_start][cite: 113, 114] '臺東縣', 'W': '金門縣', 'X': '澎湖縣', 'Z': '連江縣' };
        
        const columnMappings = {
            'a': { '編號': '編號', '鄉鎮市區': '行政區', '交易標的': '交易標的', '土地位置建物門牌': '地址', '交易年月日': '交易日', '交易筆棟數': '交易筆棟數', '移轉層次': '樓層', '建物型態': '建物型態', '主要用途': '主要用途', '建物移轉總面積平方公尺': '產權面積_房車', '建物現況格局-房': '房數', '建物現況格局-廳': '廳數', '建物現況格局-衛': '衛浴數', '總價元': '交易總價', '車位類別': '車位類別', '車位移轉總面積平方公尺': '車位總面積', '車位總價元': '車位總價', '備註': '備註', '主建物面積': '主建物面積', '附屬建物面積': '附屬建物面積', '陽台面積': '陽台面積'},
            
            'a_build': { 
                '編號': '編號', 
                '屋齡': '交易屋齡', 
                '主要建材': '結構', 
                '建築完成年月日': '完工日',
                '建築完成日期': '完工日',
                '總層數': '總樓層', 
                '移轉情形': '移轉情形' 
            },
            
            'a_land': { '編號': '編號', '土地位置': '地號_段', '地號': '地號', '土地移轉面積平方公尺': '土地持分面積', '使用分區或編定': '使用分區', '非都市土地使用分區': '使用分區', '權利人持分分母': '持分分母', '權利人持分分子': '持分分子' },
            'a_park': { '編號': '編號', '車位類別': '車位類別', '車位價格': '車位價格', '車位面積平方公尺': '車位面積', '車位所在樓層': '車位樓層' },
            'b': { '編號': '編號', '鄉鎮市區': '行政區', '交易標的': '交易標的', '土地位置建物門牌': '地址', '交易年月日': '交易日', '交易筆棟數': '交易筆棟數', '移轉層次': '樓層', '總層數': '總樓層', '建物型態': '建物型態', '主要用途': '主要用途', '建物移轉總面積平方公尺': '產權面積_房車', '建物現況格局-房': '房數', '建物現況格局-廳': '廳數', 
[cite_start][cite: 115, 116] '建物現況格局-衛': '衛浴數', '總價元': '交易總價', '車位類別': '車位類別', '車位移轉總面積平方公尺': '車位總面積', '車位總價元': '車位總價', '備註': '備註', '建案名稱': '建案名稱', '棟及號': '戶別', '解約情形': '解約情形' },
            'b_land': { '編號': '編號', '土地位置': '地號_段', '地號': '地號', '土地移轉面積平方公尺': '土地持分面積', '使用分區或編定': '使用分區', '非都市土地使用分區': '使用分區', '權利人持分分母': '持分分母', '權利人持分分子': '持分分子' },
            'b_park': { '編號': '編號', '車位類別': '車位類別', '車位價格': '車位價格', '車位面積平方公尺': '車位面積', '車位所在樓層': '車位樓層' },
            'c': { '編號': '編號', '鄉鎮市區': '行政區', '交易標的': '交易標的', '土地位置建物門牌': '地址', '租賃年月日': '交易日', '租賃筆棟數': '交易筆棟數', '租賃層次': '樓層', 
[cite_start][cite: 116, 117] '建物型態': '建物型態', '主要用途': '主要用途', '建物總面積平方公尺': '租賃面積', '建物現況格局-房': '房數', '建物現況格局-廳': '廳數', '建物現況格局-衛': '衛浴數', '總額元': '交易總價', '車位類別': '車位類別', '車位面積平方公尺': '車位總面積', '車位總額元': '車位總價', '備註': '備註', '出租型態': '出租型態', '租賃期間': '租賃期間', '附屬設備': '附屬設備', '租賃住宅服務': '租賃住宅服務' },

            'c_build': { 
                '編號': '編號', 
                '屋齡': '交易屋齡', 
                '主要建材': '結構', 
                '建築完成年月日': '完工日',
                '建築完成日期': '完工日',
                '總層數': '總樓層', 
                '移轉情形': '移轉情形' 
            },

            'c_land': { '編號': '編號', '土地位置': '地號_段', '地號': '地號', '土地移轉面積平方公尺': '土地租賃面積', '使用分區或編定': '使用分區', '非都市土地使用分區': '使用分區' },
            'c_park': { '編號': '編號', '車位類別': '車位類別', 
[cite_start][cite: 117, 118] '車位價格': '車位價格', '車位面積平方公尺': '車位面積', '車位所在樓層': '車位樓層' }
        };
        
        let supabase = null;
[cite_start][cite: 118, 119] let allFiles = [];
        let processedMainIds = new Set();
        let summary = { new: 0, updated: 0, identical: 0, subAdded: 0, errors: 0 };
[cite_start][cite: 119, 120] let isUploading = false;

        // DOM Elements
        const DOM = {
            selectFoldersButton: document.getElementById('selectFoldersButton'),
            startUploadButton: document.getElementById('startUploadButton'),
            testConnectionButton: document.getElementById('testConnectionButton'),
            statusContainer: document.getElementById('statusContainer'),
            errorLogContainer: document.getElementById('errorLogContainer'),
            fileListContainer: document.getElementById('fileListContainer'),
     
[cite_start][cite: 120, 121]        fileList: document.getElementById('fileList'),
            progressCircle: document.getElementById('progressCircle'),
            progressPercent: document.getElementById('progressPercent'),
            progressStatus: document.getElementById('progressStatus'),
            currentFileName: document.getElementById('currentFileName'),
            connectionStatus: document.getElementById('connectionStatus'),
            connectionText: document.getElementById('connectionText'),
            dbStatus: document.getElementById('dbStatus'),
 
[cite_start][cite: 121, 122]            dbStatusIndicator: document.getElementById('dbStatusIndicator'),
            dbStatusText: document.getElementById('dbStatusText'),
            totalFiles: document.getElementById('totalFiles'),
            successCount: document.getElementById('successCount'),
            errorCount: document.getElementById('errorCount'),
            processingSpeed: document.getElementById('processingSpeed'),
            newRecords: document.getElementById('newRecords'),
          
[cite_start][cite: 122, 123]   updatedRecords: document.getElementById('updatedRecords'),
            skippedRecords: document.getElementById('skippedRecords'),
            errorRecords: document.getElementById('errorRecords'),
            currentTime: document.getElementById('currentTime')
        };
[cite_start][cite: 123, 124] // Utility Functions
        function cleanNumber(value) {
            if (typeof value !== 'string' && typeof value !== 'number') return null;
[cite_start][cite: 124, 125] const cleaned = String(value).replace(/,/g, '');
            const num = parseFloat(cleaned);
            return isNaN(num) ? null : num;
[cite_start][cite: 125, 126] }

        function rocToDate(rocDateStr) {
            if (!rocDateStr || typeof rocDateStr !== 'string' || rocDateStr.length < 7) return null;
[cite_start][cite: 126, 127] try {
                const year = parseInt(rocDateStr.substring(0, 3), 10) + 1911;
[cite_start][cite: 127, 128] const month = rocDateStr.substring(3, 5);
                const day = rocDateStr.substring(5, 7);
                const date = new Date(`${year}-${month}-${day}`);
                return isNaN(date.getTime()) ?
[cite_start][cite: 128, 129] null : date.toISOString().split('T')[0];
            } catch (e) { return null; }
        }
        
        function processRow(row, mapping) {
            const newRow = {};
[cite_start][cite: 129, 130] const targetDbColumns = [...new Set(Object.values(mapping))];
            targetDbColumns.forEach(col => newRow[col] = null);
[cite_start][cite: 130, 131] for (const csvHeader in row) {
                const dbColumn = mapping[csvHeader];
[cite_start][cite: 131, 132] if (dbColumn) {
                    let value = row[csvHeader];
[cite_start][cite: 132, 133] if (value === undefined || value === '') continue;
                    if (dbColumn.includes('日')) {
                        newRow[dbColumn] = rocToDate(String(value));
[cite_start][cite: 133, 134] } else if (['交易總價', '車位總價', '房數', '廳數', '衛浴數', '持分分母', '持分分子', '交易屋齡', '車位價格'].includes(dbColumn)) {
                        newRow[dbColumn] = parseInt(cleanNumber(value), 10);
[cite_start][cite: 134, 135] if(isNaN(newRow[dbColumn])) newRow[dbColumn] = null;
                    } else if (dbColumn.includes('面積')) {
                        newRow[dbColumn] = cleanNumber(value);
[cite_start][cite: 135, 136] } else {
                        newRow[dbColumn] = String(value);
[cite_start][cite: 136, 137] }
                }
            }
            return newRow;
[cite_start][cite: 137, 138] }

        function isEqual(objA, objB, tableType) {
            const keysToCheck = Object.values(columnMappings[tableType]);
[cite_start][cite: 138, 139] for (const key of keysToCheck) {
                if (key === 'id') continue;
[cite_start][cite: 139, 140] const valA = objA[key] ?? '';
                const valB = objB[key] ?? '';
[cite_start][cite: 140, 141] if (key.includes('面積')) {
                    if (Math.abs(cleanNumber(valA) - cleanNumber(valB)) > 0.001) return false;
[cite_start][cite: 141, 142] } else {
                     if (String(valA) !== String(valB)) return false;
[cite_start][cite: 142, 143] }
            }
            return true;
[cite_start][cite: 143, 144] }

        // UI Functions
        function updateConnectionStatus(isConnected) {
            const statusClass = isConnected ?
[cite_start][cite: 144, 145] 'status-online' : 'status-offline';
            const statusText = isConnected ? '已連線' : '未連線';
            const dbStatusText = isConnected ? '正常' : '未連線';
[cite_start][cite: 145, 146] DOM.connectionStatus.className = `status-indicator ${statusClass}`;
            DOM.connectionText.textContent = statusText;
            DOM.dbStatus.className = `status-indicator ${statusClass}`;
            DOM.dbStatusIndicator.className = `status-indicator ${statusClass}`;
            DOM.dbStatusText.textContent = dbStatusText;
[cite_start][cite: 146, 147] }

        function updateProgress(current, total, phase = '') {
            const percentage = total > 0 ?
[cite_start][cite: 147, 148] (current / total) * 100 : 0;
            const circumference = 2 * Math.PI * 40;
[cite_start][cite: 148, 149] const offset = circumference - (percentage / 100) * circumference;
            
            DOM.progressCircle.style.strokeDashoffset = offset;
            DOM.progressPercent.textContent = `${Math.round(percentage)}%`;
            DOM.progressStatus.textContent = phase ||
[cite_start][cite: 149, 150] `${current} / ${total}`;
        }

        function addLog(message, type = 'info', container = 'status') {
            const timestamp = new Date().toLocaleTimeString();
[cite_start][cite: 150, 151] const logContainer = container === 'status' ? DOM.statusContainer : DOM.errorLogContainer;
            const typeClass = `terminal-${type}`;
            
            const logEntry = document.createElement('div');
[cite_start][cite: 151, 152] logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> <span class="${typeClass}">${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
[cite_start][cite: 152, 153] }

        function updateStats() {
            DOM.totalFiles.textContent = allFiles.length;
[cite_start][cite: 153, 154] DOM.successCount.textContent = summary.new + summary.updated + summary.subAdded;
            DOM.errorCount.textContent = summary.errors;
            DOM.newRecords.textContent = summary.new;
            DOM.updatedRecords.textContent = summary.updated;
            DOM.skippedRecords.textContent = summary.identical;
[cite_start][cite: 154, 155] DOM.errorRecords.textContent = summary.errors;
        }

        function clearLogs(type) {
            if (type === 'status') {
                DOM.statusContainer.innerHTML = '<div class="text-gray-400">日誌已清除</div>';
[cite_start][cite: 155, 156] } else {
                DOM.errorLogContainer.innerHTML = '<div class="text-gray-400">錯誤日誌已清除</div>';
[cite_start][cite: 156, 157] }
        }

        function resetUI() {
            DOM.fileListContainer.classList.add('hidden');
[cite_start][cite: 157, 158] DOM.statusContainer.innerHTML = '<div class="text-gray-400">等待操作...</div>';
            DOM.errorLogContainer.innerHTML = '<div class="text-gray-400">無錯誤記錄</div>';
            DOM.fileList.innerHTML = '';
            DOM.startUploadButton.disabled = false;
            DOM.selectFoldersButton.disabled = false;
            allFiles = [];
[cite_start][cite: 158, 159] processedMainIds.clear();
            summary = { new: 0, updated: 0, identical: 0, subAdded: 0, errors: 0 };
            updateStats();
            updateProgress(0, 0);
[cite_start][cite: 159, 160] }

        // File Handling
        async function selectFolders() {
            resetUI();
[cite_start][cite: 160, 161] if (!window.showDirectoryPicker) {
                addLog('您的瀏覽器不支援資料夾選擇功能，請使用最新版本的 Chrome 或 Edge 瀏覽器。', 'error');
[cite_start][cite: 161, 162] return;
            }
            
            try {
                addLog('正在掃描資料夾...', 'info');
[cite_start][cite: 162, 163] const dirHandle = await window.showDirectoryPicker();
                const fileHandles = await scanDirectory(dirHandle);
                const fileRegex = /^([a-z])_lvr_land_([a-c](?:_build|_land|_park)?)\.csv$/i;
[cite_start][cite: 163, 164] allFiles = fileHandles.map(handle => {
                    const match = handle.name.match(fileRegex);
                    return match ? { 
                        fileHandle: handle, 
                       
[cite_start][cite: 164, 165]  name: handle.name, 
                        countyCode: match[1].toLowerCase(), 
                        tableType: match[2].toLowerCase(), 
                        isMain: !match[2].includes('_') 
                   
[cite_start][cite: 165, 166]  } : null;
                }).filter(Boolean);
[cite_start][cite: 166, 167] if (allFiles.length === 0) {
                    addLog('在選擇的資料夾中沒有找到符合命名規則的檔案。', 'warning');
[cite_start][cite: 167, 168] return;
                }
                
                // Display file list
                DOM.fileList.innerHTML = '';
[cite_start][cite: 168, 169] allFiles.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between p-2 bg-gray-700 rounded text-sm';
                    fileItem.innerHTML = `
                        <span 
[cite_start][cite: 169, 170] class="font-mono">${file.name}</span>
                        <span class="px-2 py-1 bg-cyan-accent/20 text-cyan-accent rounded text-xs">
                            ${file.isMain ? '主表' : '附表'}
                        </span>
              
[cite_start][cite: 170, 171]       `;
                    DOM.fileList.appendChild(fileItem);
                });
[cite_start][cite: 171, 172] DOM.fileListContainer.classList.remove('hidden');
                addLog(`掃描完成！找到 ${allFiles.length} 個有效檔案。`, 'success');
                updateStats();
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    addLog(`選擇資料夾時發生錯誤: ${err.message}`, 'error');
[cite_start][cite: 172, 173] }
            }
        }

        async function scanDirectory(dirHandle, path = '') {
            let files = [];
[cite_start][cite: 173, 174] for await (const entry of dirHandle.values()) {
                const currentPath = path ?
[cite_start][cite: 174, 175] `${path}/${entry.name}` : entry.name;
                if (entry.kind === 'file' && entry.name.toLowerCase().endsWith('.csv')) {
                    files.push(entry);
[cite_start][cite: 175, 176] } else if (entry.kind === 'directory') {
                    files.push(...await scanDirectory(entry, currentPath));
[cite_start][cite: 176, 177] }
            }
            return files;
[cite_start][cite: 177, 178] }

        // Database Operations
        async function testConnection() {
            const supabaseUrl = document.getElementById('supabaseUrl').value;
[cite_start][cite: 178, 179] const supabaseKey = document.getElementById('supabaseKey').value;
            
            if (!supabaseUrl || !supabaseKey) {
                addLog('請填寫完整的 Supabase URL 和 Service Role Key。', 'error');
[cite_start][cite: 179, 180] return;
            }
            
            addLog('正在測試連線...', 'info');
[cite_start][cite: 180, 181] try {
                const testSupabase = window.supabase.createClient(supabaseUrl, supabaseKey);
[cite_start][cite: 181, 182] const { error } = await testSupabase.from('county_codes').select('code', { count: 'exact', head: true });
                
                if (error) throw error;
                
                addLog('連線成功！', 'success');
                updateConnectionStatus(true);
[cite_start][cite: 182, 183] supabase = testSupabase;
                
            } catch (error) {
                addLog(`連線失敗: ${error.message}`, 'error');
[cite_start][cite: 183, 184] updateConnectionStatus(false);
            }
        }

        async function startUpload() {
            if (!supabase) {
                addLog('請先測試 Supabase 連線', 'error');
[cite_start][cite: 184, 185] return;
            }
            
            if (allFiles.length === 0) {
                addLog('請先選擇要上傳的檔案', 'error');
[cite_start][cite: 185, 186] return;
            }
            
            isUploading = true;
[cite_start][cite: 186, 187] DOM.startUploadButton.disabled = true;
            DOM.selectFoldersButton.disabled = true;
            
            summary = { new: 0, updated: 0, identical: 0, subAdded: 0, errors: 0 };
[cite_start][cite: 187, 188] addLog('開始上傳流程...', 'info');
            
            const mainTables = allFiles.filter(f => f.isMain);
            const subTables = allFiles.filter(f => !f.isMain);
[cite_start][cite: 188, 189] await processPhase(mainTables, '階段 1: 主表 (智慧更新)', true);
            await processPhase(subTables, '階段 2: 附表 (智慧連動)', false);
            
            addLog('所有檔案處理完成！', 'success');
            updateStats();
            
            DOM.selectFoldersButton.disabled = false;
[cite_start][cite: 189, 190] isUploading = false;
        }

        async function processPhase(files, phaseName, isSmartUpdate) {
            if (files.length === 0) {
                addLog(`在 ${phaseName} 中沒有需要上傳的檔案，跳過此階段。`, 'info');
[cite_start][cite: 190, 191] return;
            }
            
            addLog(`--- ${phaseName} ---`, 'info');
[cite_start][cite: 191, 192] for (let i = 0; i < files.length; i++) {
                const fileInfo = files[i];
[cite_start][cite: 192, 193] updateProgress(i, files.length, phaseName);
                DOM.currentFileName.textContent = fileInfo.name;
                
                if (isSmartUpdate) {
                    await uploadMainFileWithSmartUpdate(fileInfo);
[cite_start][cite: 193, 194] } else {
                    await uploadSubFile(fileInfo);
[cite_start][cite: 194, 195] }
                
                updateProgress(i + 1, files.length, phaseName);
[cite_start][cite: 195, 196] updateStats();
            }
            
            DOM.currentFileName.textContent = '';
[cite_start][cite: 196, 197] }

        async function uploadMainFileWithSmartUpdate(fileInfo) {
            try {
                const tableName = `${fileInfo.countyCode}_lvr_land_${fileInfo.tableType}`;
[cite_start][cite: 197, 198] const processedData = await parseFile(fileInfo);
                
                if (!processedData || processedData.length === 0) {
                    addLog(`${fileInfo.name}: 檔案為空或解析失敗，已跳過`, 'warning');
[cite_start][cite: 198, 199] return;
                }
                
                const chunkSize = 500;
[cite_start][cite: 199, 200] for (let i = 0; i < processedData.length; i += chunkSize) {
                    const chunk = processedData.slice(i, i + chunkSize);
[cite_start][cite: 200, 201] const idsToCheck = chunk.map(row => row['編號']);
                    
                    const { data: existingData, error: fetchError } = await supabase
                        .from(tableName)
                        .select('*')
                        .in('編號', idsToCheck);
[cite_start][cite: 201, 202] if (fetchError) throw fetchError;

                    const existingDataMap = new Map(existingData.map(item => [item['編號'], item]));
                    const newData = [];
                    const updatedData = [];
[cite_start][cite: 202, 203] const idsToDelete = [];
                    let identicalCount = 0;

                    for (const newRecord of chunk) {
                        const existingRecord = existingDataMap.get(newRecord['編號']);
[cite_start][cite: 203, 204] if (!existingRecord) {
                            newData.push(newRecord);
[cite_start][cite: 204, 205] } else if (!isEqual(newRecord, existingRecord, fileInfo.tableType)) {
                            idsToDelete.push(newRecord['編號']);
[cite_start][cite: 205, 206] updatedData.push(newRecord);
                        } else {
                            identicalCount++;
[cite_start][cite: 206, 207] }
                    }
                    
                    addLog(`${fileInfo.name} (區塊 ${Math.floor(i/chunkSize) + 1}): 新增 ${newData.length}, 更新 ${updatedData.length}, 跳過 ${identicalCount}`, 'info');
[cite_start][cite: 207, 208] summary.new += newData.length;
                    summary.updated += updatedData.length;
                    summary.identical += identicalCount;

                    const idsToProcess = [...newData.map(r => r['編號']), ...updatedData.map(r => r['編號'])];
[cite_start][cite: 208, 209] idsToProcess.forEach(id => processedMainIds.add(id));

                    if (idsToDelete.length > 0) {
                        const { error: deleteError } = await supabase
                            .from(tableName)
                            .delete()
      
[cite_start][cite: 209, 210].in('編號', idsToDelete);
[cite_start][cite: 210, 211] if (deleteError) throw deleteError;
                    }

                    const dataToUpload = [...newData, ...updatedData];
[cite_start][cite: 211, 212] if (dataToUpload.length > 0) {
                        const { error: insertError } = await supabase
                            .from(tableName)
                            .insert(dataToUpload);
[cite_start][cite: 212, 213] if (insertError) throw insertError;
                    }
                }
            } catch (error) {
                addLog(`${fileInfo.name} 上傳失敗: ${error.message}`, 'error', 'error');
[cite_start][cite: 213, 214] summary.errors++;
            }
        }

        async function uploadSubFile(fileInfo) {
            try {
                const tableName = `${fileInfo.countyCode}_lvr_land_${fileInfo.tableType}`;
[cite_start][cite: 214, 215] const allSubData = await parseFile(fileInfo);
                
                if (!allSubData || allSubData.length === 0) {
                    addLog(`${fileInfo.name}: 檔案為空或解析失敗，已跳過`, 'warning');
[cite_start][cite: 215, 216] return;
                }

                const dataToUpload = allSubData.filter(row => processedMainIds.has(row['編號']));
[cite_start][cite: 216, 217] if (dataToUpload.length > 0) {
                    const { error } = await supabase.from(tableName).insert(dataToUpload);
[cite_start][cite: 217, 218] if (error) throw error;
                    
                    summary.subAdded += dataToUpload.length;
                    addLog(`${fileInfo.name}: 成功新增 ${dataToUpload.length} 筆關聯的附表紀錄`, 'success');
[cite_start][cite: 218, 219] } else {
                    addLog(`${fileInfo.name}: 無對應的主表變更，已跳過`, 'info');
[cite_start][cite: 219, 220] }
            } catch (error) {
                addLog(`${fileInfo.name} 上傳失敗: ${error.message}`, 'error', 'error');
[cite_start][cite: 220, 221] summary.errors++;
            }
        }

        async function parseFile(fileInfo) {
            const file = await fileInfo.fileHandle.getFile();
[cite_start][cite: 221, 222] const parseResult = await new Promise((resolve, reject) => {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: resolve, error: reject });
            });
[cite_start][cite: 222, 223] if (parseResult.errors.length > 0) {
                throw new Error(`CSV 解析錯誤: ${parseResult.errors[0].message}`);
[cite_start][cite: 223, 224] }
            
            let dataRows = parseResult.data;
[cite_start][cite: 224, 225] if (dataRows.length > 0 && dataRows[0]['編號']?.toLowerCase().includes('serial number')) {
                dataRows.shift();
[cite_start][cite: 225, 226] }
            
            const mapping = columnMappings[fileInfo.tableType];
[cite_start][cite: 226, 227] if (!mapping) {
                throw new Error(`檔案 ${fileInfo.name} 找不到對應規則。`);
[cite_start][cite: 227, 228] }
            
            return dataRows.map(row => processRow(row, mapping));
[cite_start][cite: 228, 229] }

        // Initialize
        function updateTime() {
            DOM.currentTime.textContent = new Date().toLocaleTimeString();
[cite_start][cite: 229, 230] }

        // Event Listeners
        DOM.selectFoldersButton.addEventListener('click', selectFolders);
[cite_start][cite: 230, 231] DOM.startUploadButton.addEventListener('click', startUpload);
        DOM.testConnectionButton.addEventListener('click', testConnection);

        // Initialize
        updateTime();
        setInterval(updateTime, 1000);
        updateConnectionStatus(false);
        updateStats();
[cite_start][cite: 231, 232] // Add some demo data for visual effect
        setTimeout(() => {
            DOM.processingSpeed.textContent = '1,247';
        }, 1000);
[cite_start][cite: 232, 233] </script>
</body>
</html>
